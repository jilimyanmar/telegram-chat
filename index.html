<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Telegram Admin</title>

<style>
body{margin:0;font-family:Arial;background:#e5ddd5}
.app{display:flex;height:100vh}
.sidebar{width:30%;background:#fff;border-right:1px solid #ccc;overflow:auto}
.user{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.user.active{background:#0088cc;color:#fff}
.preview{font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{background:red;color:white;border-radius:10px;padding:2px 6px;font-size:12px;float:right}
.chat{width:70%;display:flex;flex-direction:column}
.header{background:#0088cc;color:#fff;padding:10px}
.messages{flex:1;padding:10px;overflow:auto}
.bubble{max-width:70%;padding:8px;margin:5px 0;border-radius:8px}
.user-msg{background:#fff}
.admin-msg{background:#dcf8c6;margin-left:auto}
.input{padding:10px;background:#f0f0f0}
</style>
</head>

<body>

<div class="app">
  <div class="sidebar" id="users"></div>

  <div class="chat">
    <div class="header" id="header">Select user</div>
    <div class="messages" id="chat"></div>
    <div class="input">
      <input id="text" placeholder="Type message" style="width:100%;padding:8px">
    </div>
  </div>
</div>

<script>
var API = "https://script.google.com/macros/s/AKfycbxSkmLEdi-aYAZWo8JsEQMxQ-DK5__1fcdeE80HsIVz3mmulYZ6UgYdt2InXsTLZkwsLg/exec";

var chats = {};
var current = null;

function load(){
  fetch(API + "?t=" + new Date().getTime())
    .then(function(r){ return r.json(); })
    .then(function(data){
      chats = data || {};
      renderUsers();

      if(!current){
        for(var id in chats){
          current = id;
          openChat(id);
          break;
        }
      }
    })
    .catch(function(e){
      alert("JS ERROR: " + e);
    });
}

function renderUsers(){
  var users = document.getElementById("users");
  users.innerHTML = "";

  for(var id in chats){
    var u = chats[id];
    var last = u.messages[u.messages.length - 1];
    var text = last && last.text ? last.text : "";

    var div = document.createElement("div");
    div.className = "user" + (id===current?" active":"");
    div.onclick = (function(cid){
      return function(){ openChat(cid); };
    })(id);

    div.innerHTML =
      "<b>"+u.name+"</b>" +
      (u.unread>0 ? "<span class='badge'>"+u.unread+"</span>" : "") +
      "<div class='preview'>"+text+"</div>";

    users.appendChild(div);
  }
}

function openChat(id){
  current = id;
  var u = chats[id];
  document.getElementById("header").innerText = u.name;

  var chat = document.getElementById("chat");
  chat.innerHTML = "";

  for(var i=0;i<u.messages.length;i++){
    var m = u.messages[i];
    var d = document.createElement("div");
    d.className = "bubble " + (m.from==="admin"?"admin-msg":"user-msg");
    d.innerText = m.text || "";
    chat.appendChild(d);
  }

  chat.scrollTop = chat.scrollHeight;
  u.unread = 0;
  renderUsers();
}

document.getElementById("text").addEventListener("keydown", function(e){
  if(e.keyCode===13){
    var t = this.value.trim();
    if(!t || !current) return;

    fetch(API+"?send=1&chatId="+current+"&text="+encodeURIComponent(t))
      .then(function(){
        document.getElementById("text").value="";
        setTimeout(load,300);
      });
  }
});

load();
setInterval(load,3000);
</script>

</body>
</html>
