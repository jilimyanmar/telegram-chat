<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Telegram Admin</title>

<style>
body{margin:0;font-family:Arial;background:#dfe7ec}
.app{display:flex;height:100vh}

/* LEFT */
.sidebar{
  width:32%;
  background:#fff;
  border-right:1px solid #ccc;
  overflow-y:auto;
}
.user{
  padding:12px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.user.active{background:#0088cc;color:white}
.name{font-weight:bold}
.preview{
  font-size:13px;
  color:#666;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.badge{
  background:red;
  color:white;
  border-radius:12px;
  padding:2px 7px;
  font-size:12px;
  float:right;
}

/* CHAT */
.chat-area{width:68%;display:flex;flex-direction:column;background:#e5ddd5}
.header{background:#0088cc;color:white;padding:12px}
.messages{flex:1;padding:15px;overflow-y:auto}
.bubble{
  max-width:65%;
  padding:10px;
  margin-bottom:8px;
  border-radius:10px;
}
.user-msg{background:white}
.admin-msg{background:#dcf8c6;margin-left:auto}
.time{font-size:11px;color:#666;margin-top:4px}

/* INPUT */
.input{
  padding:10px;
  background:#f0f0f0;
}
.input input{
  width:100%;
  padding:10px;
  margin-bottom:5px;
}
</style>
</head>

<body>

<div class="app">

  <div class="sidebar" id="users"></div>

  <div class="chat-area">
    <div class="header" id="header">Select chat</div>
    <div class="messages" id="chat"></div>
    <div class="input">
      <input id="text" placeholder="Message">
      <input id="image" placeholder="Image URL (optional)">
      <button onclick="send()">Send</button>
    </div>
  </div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxSkmLEdi-aYAZWo8JsEQMxQ-DK5__1fcdeE80HsIVz3mmulYZ6UgYdt2InXsTLZkwsLg/exec";

let chats = {};
let current = null;

function load() {
  fetch(API + "?t=" + Date.now()) // ðŸ”¥ cache buster
    .then(res => res.json())
    .then(data => {
      chats = data || {};
      renderUsers();

      if (!current && Object.keys(chats).length > 0) {
        current = Object.keys(chats)[0];
        openChat(current);
      }
    })
    .catch(err => console.log("Fetch error", err));
}


function renderUsers() {
  let html = "";

  Object.keys(chats).forEach(id => {
    const u = chats[id];
    const last = u.messages[u.messages.length - 1];

    html += `
      <div class="user ${id === current ? 'active' : ''}" onclick="openChat('${id}')">
        <div class="name">${u.name || 'User'}</div>
        <div class="preview">
          ${last?.text || (last?.photo ? 'ðŸ“· Photo' : '')}
        </div>
        ${u.unread > 0 ? `<span class="badge">${u.unread}</span>` : ''}
      </div>
    `;
  });

  document.getElementById("users").innerHTML = html;
}

function openChat(id) {
  current = id;
  const u = chats[id];
  document.getElementById("header").innerText = u.name || "User";

  let html = "";
  u.messages.forEach(m => {
    html += `
      <div class="bubble ${m.from === 'admin' ? 'admin-msg' : 'user-msg'}">
        ${m.text || ''}
        <div class="time">${m.time || ''}</div>
      </div>
    `;
  });

  document.getElementById("chat").innerHTML = html;
  document.getElementById("chat").scrollTop = chat.scrollHeight;

  // Reset unread visually
  u.unread = 0;
  renderUsers();
}

function send() {
  if (!current) return alert("Select a user first");

  const t = document.getElementById("text").value.trim();
  if (!t) return;

  fetch(API + `?send=1&chatId=${current}&text=` + encodeURIComponent(t))
    .then(() => {
      document.getElementById("text").value = "";
      load();
      setTimeout(() => openChat(current), 300);
    });
}

// Start polling
load();
setInterval(load, 3000);
</script>


</body>
</html>
